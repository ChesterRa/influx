#!/usr/bin/env python3
"""
influx-rube-bridge: Bridge script to fetch Twitter users via RUBE MCP

This script does not perform API calls itself. It informs the user to run the
Claude Code RUBE MCP workflow to fetch user profiles, and exits with code 2
as a sentinel for "not implemented here".
"""
import argparse
import sys
from pathlib import Path


def parse_args():
    parser = argparse.ArgumentParser(
        description="Bridge: prepare handles for TWITTER_USER_LOOKUP_BY_USERNAMES via RUBE MCP"
    )
    parser.add_argument(
        "--handles",
        help="Comma-separated Twitter handles (without @)"
    )
    parser.add_argument(
        "--handles-file",
        help="Path to CSV or text file with a 'handle' column or one handle per line"
    )
    return parser.parse_args()


def load_handles_from_file(path: str):
    p = Path(path)
    if not p.exists():
        print(f"[ERROR] handles-file not found: {path}", file=sys.stderr)
        sys.exit(1)
    handles = []
    try:
        import csv
        with open(p, 'r', encoding='utf-8') as f:
            # Try CSV first
            try:
                reader = csv.DictReader(f)
                if reader.fieldnames and 'handle' in [h.strip().lower() for h in reader.fieldnames]:
                    for row in reader:
                        h = (row.get('handle') or '').strip().lstrip('@')
                        if h:
                            handles.append(h)
                else:
                    raise ValueError("not a CSV with handle header")
            except Exception:
                # Fallback to one-per-line text
                f.seek(0)
                for line in f:
                    h = line.strip().split(',')[0].strip().lstrip('@')
                    if h and not h.startswith('#'):
                        handles.append(h)
    except Exception as e:
        print(f"[ERROR] Failed to read handles-file: {e}", file=sys.stderr)
        sys.exit(1)
    return handles


def main():
    args = parse_args()

    handles = []
    if args.handles:
        handles.extend([h.strip().lstrip('@') for h in args.handles.split(',') if h.strip()])
    if args.handles_file:
        handles.extend(load_handles_from_file(args.handles_file))

    # Deduplicate and filter empties
    handles = [h for h in dict.fromkeys(handles) if h]

    if not handles:
        print("[ERROR] No handles provided. Use --handles or --handles-file", file=sys.stderr)
        return 1

    joined = ' '.join([f"@{h}" for h in handles])

    # Inform the user how to run via Claude Code + RUBE MCP
    print("This script requires Claude Code RUBE MCP.")
    print("Run via: claude-code exec rube-fetch " + joined)
    print("\nThen pass the JSONL output to influx-harvest:")
    print("  influx-harvest x-lists --list-urls <csv> --prefetched-users <users.jsonl> --out harvest.raw.jsonl")

    # Exit 2 as a sentinel for 'not implemented here'
    return 2


if __name__ == "__main__":
    sys.exit(main())

