#!/usr/bin/env python3
"""
influx-rube-mcp: Main RUBE MCP Integration Tool

Comprehensive tool for RUBE MCP workflow management including:
- Session management and configuration
- Batch user data fetching from Twitter/X
- Advanced error handling and retry logic
- Workflow monitoring and reporting
- Integration with existing influx pipeline

Usage:
    influx-rube-mcp harvest --input handles.csv --out results.jsonl
    influx-rube-mcp monitor --session-id abc123
    influx-rube-mcp retry session_abc123 --out retry_results.jsonl
    influx-rube-mcp report --days 7
"""

import sys
import os
from pathlib import Path

# Add scripts directory to path
scripts_dir = Path(__file__).parent.parent / "scripts"
sys.path.insert(0, str(scripts_dir))

try:
    from rube_mcp_config import RubeMCPConfig
    from rube_mcp_integration import RubeMCPIntegration
    from rube_workflow_monitor import RubeWorkflowMonitor
    from rube_batch_processor import RubeBatchProcessor
except ImportError as e:
    print(f"[ERROR] Failed to import RUBE MCP modules: {e}", file=sys.stderr)
    print("[ERROR] Make sure all RUBE MCP scripts are in the scripts/ directory", file=sys.stderr)
    sys.exit(1)


def main():
    """Main CLI interface"""
    import argparse
    
    parser = argparse.ArgumentParser(
        description="influx-rube-mcp: RUBE MCP Integration for Influx",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Harvest user data from CSV with advanced error handling
  influx-rube-mcp harvest --input handles.csv --out results.jsonl --batch-size 50

  # Monitor active workflows
  influx-rube-mcp monitor --interval 30

  # Retry failed workflow
  influx-rube-mcp retry session_abc123 --out retry_results.jsonl

  # Generate performance report
  influx-rube-mcp report --days 7

  # Create new session
  influx-rube-mcp session create --workflow-type bulk_harvest

  # Show current configuration
  influx-rube-mcp config show
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", required=True, help="Available commands")
    
    # harvest command
    harvest_parser = subparsers.add_parser("harvest", help="Harvest user data using RUBE MCP")
    harvest_parser.add_argument("input", help="Input file with handles (CSV or text format)")
    harvest_parser.add_argument("output", help="Output JSONL file for processed results")
    harvest_parser.add_argument("--batch-size", type=int, default=75, help="Handles per batch (default: 75)")
    harvest_parser.add_argument("--max-parallel", type=int, default=3, help="Max parallel batches (default: 3)")
    harvest_parser.add_argument("--max-retries", type=int, default=3, help="Max retry attempts (default: 3)")
    harvest_parser.add_argument("--config-dir", default="config", help="Configuration directory (default: config)")
    harvest_parser.add_argument("--advanced-retry", action="store_true", help="Use advanced error handling with retry")
    harvest_parser.add_argument("--error-report-dir", default="archive/error_reports", help="Error report directory")
    
    # monitor command
    monitor_parser = subparsers.add_parser("monitor", help="Monitor active RUBE MCP workflows")
    monitor_parser.add_argument("--session-id", help="Specific session ID to monitor")
    monitor_parser.add_argument("--interval", type=int, default=30, help="Monitor interval in seconds (default: 30)")
    monitor_parser.add_argument("--config-dir", default="config", help="Configuration directory (default: config)")
    
    # retry command
    retry_parser = subparsers.add_parser("retry", help="Retry failed workflow")
    retry_parser.add_argument("session_id", help="Session ID to retry")
    retry_parser.add_argument("output", help="Output file for retry results")
    retry_parser.add_argument("--config-dir", default="config", help="Configuration directory (default: config)")
    
    # report command
    report_parser = subparsers.add_parser("report", help="Generate performance report")
    report_parser.add_argument("--days", type=int, default=7, help="Number of days to include (default: 7)")
    report_parser.add_argument("--config-dir", default="config", help="Configuration directory (default: config)")
    
    # session command
    session_parser = subparsers.add_parser("session", help="Session management")
    session_subparsers = session_parser.add_subparsers(dest="session_action", required=True)
    
    # session create
    session_create_parser = session_subparsers.add_parser("create", help="Create new session")
    session_create_parser.add_argument("--workflow-type", default="bulk_harvest", help="Workflow type (default: bulk_harvest)")
    session_create_parser.add_argument("--config-dir", default="config", help="Configuration directory (default: config)")
    
    # session get
    session_get_parser = session_subparsers.add_parser("get", help="Get current session info")
    session_get_parser.add_argument("--config-dir", default="config", help="Configuration directory (default: config)")
    
    # session close
    session_close_parser = session_subparsers.add_parser("close", help="Close current session")
    session_close_parser.add_argument("--status", default="completed", help="Session status (default: completed)")
    session_close_parser.add_argument("--config-dir", default="config", help="Configuration directory (default: config)")
    
    # config command
    config_parser = subparsers.add_parser("config", help="Configuration management")
    config_subparsers = config_parser.add_subparsers(dest="config_action", required=True)
    
    # config show
    config_show_parser = config_subparsers.add_parser("show", help="Show current configuration")
    config_show_parser.add_argument("--config-dir", default="config", help="Configuration directory (default: config)")
    
    # list command
    list_parser = subparsers.add_parser("list", help="List workflows and sessions")
    list_parser.add_argument("--type", choices=["active", "history"], default="active", help="List type (default: active)")
    list_parser.add_argument("--limit", type=int, default=10, help="Number of items to show (default: 10)")
    list_parser.add_argument("--config-dir", default="config", help="Configuration directory (default: config)")
    
    args = parser.parse_args()
    
    try:
        if args.command == "harvest":
            # Harvest user data
            if args.advanced_retry:
                # Use advanced batch processor
                processor = RubeBatchProcessor(args.config_dir)
                success = processor.run_full_workflow(
                    input_file=args.input,
                    output_file=args.output,
                    batch_size=args.batch_size,
                    max_parallel=args.max_parallel
                )
            else:
                # Use basic integration
                integration = RubeMCPIntegration(args.config_dir)
                success = integration.run_full_workflow(
                    input_file=args.input,
                    output_file=args.output,
                    batch_size=args.batch_size,
                    max_parallel=args.max_parallel
                )
            
            sys.exit(0 if success else 1)
        
        elif args.command == "monitor":
            # Monitor workflows
            monitor = RubeWorkflowMonitor(args.config_dir)
            monitor.monitor_active_workflow(args.session_id, args.interval)
        
        elif args.command == "retry":
            # Retry failed workflow
            monitor = RubeWorkflowMonitor(args.config_dir)
            success = monitor.retry_failed_workflow(args.session_id, args.output)
            sys.exit(0 if success else 1)
        
        elif args.command == "report":
            # Generate performance report
            monitor = RubeWorkflowMonitor(args.config_dir)
            report = monitor.generate_performance_report(args.days)
            print(report)
        
        elif args.command == "session":
            # Session management
            config = RubeMCPConfig(args.config_dir)
            
            if args.session_action == "create":
                session_id = config.create_session(args.workflow_type)
                print(f"Created session: {session_id}")
            
            elif args.session_action == "get":
                session = config.get_current_session()
                if session:
                    import json
                    print(json.dumps(session, indent=2))
                else:
                    print("No active session")
            
            elif args.session_action == "close":
                session = config.close_session(args.status)
                if session:
                    print(f"Closed session: {session['session_id']}")
                    import json
                    print(json.dumps(session["stats"], indent=2))
                else:
                    print("No active session to close")
        
        elif args.command == "config":
            # Configuration management
            config = RubeMCPConfig(args.config_dir)
            
            if args.config_action == "show":
                import json
                print(json.dumps(config.config, indent=2))
        
        elif args.command == "list":
            # List workflows
            monitor = RubeWorkflowMonitor(args.config_dir)
            
            if args.type == "active":
                active_workflows = monitor.get_active_workflows()
                if not active_workflows:
                    print("No active workflows")
                else:
                    for workflow in active_workflows:
                        print(f"{workflow.session_id} | {workflow.workflow_type} | {workflow.status} | {workflow.progress_percentage:.1f}%")
            else:  # history
                history = monitor.get_workflow_history(args.limit)
                if not history:
                    print("No workflow history found")
                else:
                    for item in history:
                        session_id = item.get("session_id", "unknown")[:16]
                        status = item.get("status", "unknown")
                        authors = item.get("stats", {}).get("authors_added", 0)
                        created = item.get("created_at", "")[:19]
                        print(f"- {session_id} | {status:10} | {authors:4} authors | {created}")
    
    except KeyboardInterrupt:
        print("\n[INFO] Operation cancelled by user", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"[ERROR] {e}", file=sys.stderr)
        import traceback
        traceback.print_exc(file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
