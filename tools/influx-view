#!/usr/bin/env python3
"""
influx-view: Read-only viewer for influx data with syntax highlighting

Usage:
    influx-view [--lines N] [FILE]

Examples:
    influx-view                          # View first 20 records from latest
    influx-view --lines 10               # View first 10 records
    influx-view data/snapshots/2025-11-13/bigv-20251113.jsonl.gz
"""
import sys
import gzip
import json
import argparse
from pathlib import Path


def format_author(author, line_num):
    """Format a single author record with color highlighting."""
    # Simple ANSI color codes
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    MAGENTA = '\033[95m'
    RESET = '\033[0m'
    BOLD = '\033[1m'
    
    handle = author.get('handle', 'N/A')
    name = author.get('name', 'N/A')
    verified = author.get('verified', 'none')
    followers = author.get('followers_count', 0)
    score = author.get('meta', {}).get('score', 0.0)
    topics = ', '.join(author.get('topic_tags', []))
    
    # Verified badge
    badge = ''
    if verified == 'blue':
        badge = f'{BLUE}✓{RESET}'
    elif verified == 'org':
        badge = f'{YELLOW}✓{RESET}'
    
    # Format output
    print(f"{BOLD}{line_num:3d}.{RESET} {CYAN}@{handle}{RESET} {badge}")
    print(f"     {name}")
    print(f"     {GREEN}{followers:,}{RESET} followers · score: {MAGENTA}{score:.1f}{RESET}")
    if topics:
        print(f"     topics: {topics}")
    print()


def main():
    parser = argparse.ArgumentParser(
        description='View influx BigV data with syntax highlighting',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  influx-view                     # View first 20 from latest
  influx-view --lines 10          # View first 10
  influx-view data/snapshots/2025-11-13/bigv-20251113.jsonl.gz
        """
    )
    parser.add_argument('file', nargs='?', default='data/latest/latest.jsonl.gz',
                        help='JSONL or gzipped JSONL file (default: data/latest/latest.jsonl.gz)')
    parser.add_argument('--lines', '-n', type=int, default=20,
                        help='Number of records to display (default: 20)')
    parser.add_argument('--json', action='store_true',
                        help='Output raw JSON instead of formatted view')
    
    args = parser.parse_args()
    
    file_path = Path(args.file)
    if not file_path.exists():
        print(f"Error: File not found: {file_path}", file=sys.stderr)
        return 1
    
    # Determine if file is gzipped
    is_gzipped = file_path.suffix == '.gz'
    
    try:
        if is_gzipped:
            f = gzip.open(file_path, 'rt', encoding='utf-8')
        else:
            f = open(file_path, 'r', encoding='utf-8')
        
        count = 0
        for line in f:
            line = line.strip()
            if not line:
                continue
            
            try:
                author = json.loads(line)
                
                if args.json:
                    print(json.dumps(author, indent=2, ensure_ascii=False))
                else:
                    format_author(author, count + 1)
                
                count += 1
                if count >= args.lines:
                    break
            except json.JSONDecodeError as e:
                print(f"Warning: Skipping invalid JSON at line {count + 1}: {e}", file=sys.stderr)
                continue
        
        f.close()
        
        if count == 0:
            print(f"No records found in {file_path}", file=sys.stderr)
            return 1
        
        return 0
        
    except Exception as e:
        print(f"Error reading file: {e}", file=sys.stderr)
        return 1


if __name__ == '__main__':
    sys.exit(main())
