name: Schema & Quality Validation

on:
  pull_request:
    paths:
      - 'data/release/*'
      - 'schema/bigv.schema.json'
      - 'scripts/pipeline_guard.sh'
      - '.github/workflows/validate.yml'
  push:
    branches:
      - main
    paths:
      - 'data/release/*'
      - 'schema/bigv.schema.json'
      - 'scripts/pipeline_guard.sh'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Validate release data (if present)
        run: |
          if [ -f scripts/pipeline_guard.sh ] && [ -f data/release/influx-latest.jsonl ]; then
            echo "=== pipeline_guard: data/release/influx-latest.jsonl ==="
            scripts/pipeline_guard.sh \
              data/release/influx-latest.jsonl \
              data/release/manifest.json \
              schema/bigv.schema.json
          else
            echo "⚠ release data or pipeline_guard.sh not found, skipping"
          fi

      - name: Validate schema itself
        run: |
          echo "=== Checking schema validity ==="
          python3 -c "
          import json
          from jsonschema import Draft7Validator

          with open('schema/bigv.schema.json') as f:
              schema = json.load(f)

          Draft7Validator.check_schema(schema)
          print('✓ Schema is valid JSON Schema Draft-07')
          "
